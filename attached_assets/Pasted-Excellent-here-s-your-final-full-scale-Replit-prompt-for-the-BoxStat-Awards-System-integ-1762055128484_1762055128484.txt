Excellent ‚Äî here‚Äôs your **final, full-scale Replit prompt** for the **BoxStat Awards System**, integrating:
‚úÖ full **relational database + triggers**
‚úÖ **JSON-based award config** (centralized logic)
‚úÖ **working RSVP logic**
‚úÖ **award image integration** for the Admin ‚ÄúAwards & Badges‚Äù tab (linked to your existing `/trophies-badges` assets)
‚úÖ complete `triggers.sql` file for Supabase or Postgres deployment

---

# üß† REPLIT PROMPT ‚Äî BOXSTAT AWARDS SYSTEM UPGRADE

> **Goal:**
> Upgrade BoxStat to support a **fully dynamic Awards & Badges System** with relational triggers, centralized config, RSVP tracking, and full sync between backend and dashboards.
>
> This includes:
>
> * ‚úÖ `awards.config.json`
> * ‚úÖ `triggers.sql`
> * ‚úÖ RSVP logic fix
> * ‚úÖ Award image display integration
> * ‚úÖ Admin and Player dashboard sync

---

## ‚öôÔ∏è 1Ô∏è‚É£ DATABASE STRUCTURE (PostgreSQL / Supabase)

### Amend `users` Table

```sql
ALTER TABLE users
ADD COLUMN height_in INTEGER,
ADD COLUMN position TEXT CHECK (position IN ('PG','SG','SF','PF','C')),
ADD COLUMN profile_visibility BOOLEAN DEFAULT TRUE,
ADD COLUMN total_games INTEGER DEFAULT 0,
ADD COLUMN total_fnh_games INTEGER DEFAULT 0,
ADD COLUMN total_practices INTEGER DEFAULT 0,
ADD COLUMN total_skills_sessions INTEGER DEFAULT 0,
ADD COLUMN total_checkins INTEGER DEFAULT 0,
ADD COLUMN total_rsvps INTEGER DEFAULT 0,
ADD COLUMN consecutive_rsvps INTEGER DEFAULT 0,
ADD COLUMN years_active INTEGER DEFAULT 0,
ADD COLUMN videos_completed INTEGER DEFAULT 0;
```

---

### Create `awards` Table

```sql
CREATE TABLE awards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  award_name TEXT,
  award_tier TEXT CHECK (award_tier IN ('Trophy','Badge')),
  award_class TEXT CHECK (award_class IN ('Legacy','Team','Coach','HallOfFame','Superstar','AllStar','Starter','Prospect')),
  award_type TEXT CHECK (award_type IN ('annual','lifetime','milestone')),
  year INTEGER,
  description TEXT,
  image_url TEXT,
  visible BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

### Create `checkins`, `coach_feedback`, `rsvps` Tables

```sql
CREATE TABLE checkins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  event_type TEXT CHECK (event_type IN ('Practice','Game','FNH','Skill')),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE coach_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  coach_id UUID REFERENCES users(id),
  feedback_type TEXT CHECK (feedback_type IN ('MVP','Hustle','Teammate','Student')),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE rsvps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  event_id UUID,
  event_type TEXT,
  status TEXT CHECK (status IN ('yes','no','late','missed')),
  submitted_at TIMESTAMP DEFAULT NOW()
);
```

---

## üß± 2Ô∏è‚É£ CONFIG FILE ‚Äî `/config/awards.config.json`

(Full JSON definition of all Trophies + Badges, identical to the previous version I provided.)

> Include all categories: **Trophies, HallOfFame, Superstar, AllStar, Starter, Prospect**, with the same trigger syntax.
> Each award entry should now include `"image_url"` pointing to your `/trophies-badges` assets.

Example snippet:

```json
"Heart & Hustle Award": {
  "tier": "Trophy",
  "class": "Legacy",
  "type": "annual",
  "description": "Recognizes the player who gave maximum effort all year.",
  "trigger": "manual_selection",
  "image_url": "/trophies-badges/heart-hustle.png"
}
```

---

## üß† 3Ô∏è‚É£ RSVP Logic Fix

**Goals:**

* RSVPs store correctly (linked to `users` + `events`)
* `total_rsvps` and `consecutive_rsvps` update properly
* Late/missed resets streak
* Trigger recalculates awards (`RSVP Streak`)

```ts
// /server/routes/rsvp.ts
router.post("/", async (req, res) => {
  const { user_id, event_id, status, event_type, submitted_on_time } = req.body;

  await db.query(`
    INSERT INTO rsvps (user_id, event_id, event_type, status)
    VALUES ($1, $2, $3, $4)
    ON CONFLICT (user_id, event_id)
    DO UPDATE SET status = EXCLUDED.status, submitted_at = NOW()
  `, [user_id, event_id, event_type, status]);

  if (status = 'yes') {
    await db.query(`UPDATE users SET total_rsvps = total_rsvps + 1 WHERE id = $1`, [user_id]);
    if (submitted_on_time) {
      await db.query(`UPDATE users SET consecutive_rsvps = consecutive_rsvps + 1 WHERE id = $1`, [user_id]);
    } else {
      await db.query(`UPDATE users SET consecutive_rsvps = 0 WHERE id = $1`, [user_id]);
    }
  }

  // Trigger badge logic
  await awardEngine.triggerCheck(user_id, "RSVP");

  res.json({ success: true });
});
```

---

## üß© 4Ô∏è‚É£ AWARD ENGINE ‚Äî `/server/utils/awardEngine.ts`

```ts
import config from "../../config/awards.config.json";
import db from "../db";

export async function triggerCheck(user_id: string, event_type: string) {
  const userStats = await db.query(`SELECT * FROM users WHERE id = $1`, [user_id]);
  const user = userStats.rows[0];

  for (const [tier, categories] of Object.entries(config.Badges)) {
    for (const [badgeName, badge] of Object.entries(categories)) {
      if (evaluateTrigger(user, badge.trigger)) {
        const exists = await db.query(
          `SELECT 1 FROM awards WHERE user_id = $1 AND award_name = $2`,
          [user_id, badgeName]
        );
        if (!exists.rowCount) {
          await db.query(`
            INSERT INTO awards (user_id, award_name, award_tier, award_class, award_type, description, image_url)
            VALUES ($1, $2, 'Badge', $3, 'milestone', $4, $5)
          `, [user_id, badgeName, tier, badge.description || "", badge.image_url || ""]);
        }
      }
    }
  }
}

function evaluateTrigger(user, triggerStr) {
  if (!triggerStr) return false;
  try {
    const condition = triggerStr
      .replace(/games_played/g, user.total_games)
      .replace(/fnh_games/g, user.total_fnh_games)
      .replace(/practices/g, user.total_practices)
      .replace(/skills/g, user.total_skills_sessions)
      .replace(/rsvps/g, user.total_rsvps)
      .replace(/consecutive_rsvps/g, user.consecutive_rsvps)
      .replace(/years_active/g, user.years_active)
      .replace(/videos/g, user.videos_completed);
    return eval(condition);
  } catch {
    return false;
  }
}
```

---

## üß© 5Ô∏è‚É£ TRIGGERS FILE ‚Äî `/server/db/triggers.sql`

```sql
-- Trigger MVP Badge Progression
CREATE OR REPLACE FUNCTION trigger_mvp_awards()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE users
  SET total_mvp_awards = COALESCE(total_mvp_awards, 0) + 1
  WHERE id = NEW.user_id;

  PERFORM triggerCheck(NEW.user_id, 'MVP');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_mvp_award
AFTER INSERT ON coach_feedback
FOR EACH ROW
WHEN (NEW.feedback_type = 'MVP')
EXECUTE FUNCTION trigger_mvp_awards();


-- Trigger Check-in Counters
CREATE OR REPLACE FUNCTION trigger_checkin_awards()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE users
  SET total_checkins = COALESCE(total_checkins, 0) + 1
  WHERE id = NEW.user_id;

  PERFORM triggerCheck(NEW.user_id, 'checkin');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_checkin_award
AFTER INSERT ON checkins
FOR EACH ROW
EXECUTE FUNCTION trigger_checkin_awards();


-- Trigger RSVP Badge
CREATE OR REPLACE FUNCTION trigger_rsvp_award()
RETURNS TRIGGER AS $$
BEGIN
  PERFORM triggerCheck(NEW.user_id, 'RSVP');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_rsvp_award
AFTER INSERT OR UPDATE ON rsvps
FOR EACH ROW
EXECUTE FUNCTION trigger_rsvp_award();
```

---

## üñ•Ô∏è 6Ô∏è‚É£ ADMIN DASHBOARD ‚Äî ‚ÄúAwards & Badges‚Äù

**Add to `/pages/admin/awards.tsx`:**

* Integrate with `/api/awards`
* Display `award_name`, `award_class`, `year`, `image_url`
* Add ‚ÄúAward Image‚Äù column that pulls from `/trophies-badges` (already existing)
* Include button to:

  * `+ Add Award`
  * `Recalculate All Awards`
  * Toggle visibility (for hiding awards)

Example card:

```tsx
<div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
  {awards.map(a => (
    <div key={a.id} className="border rounded-lg p-4 shadow-sm bg-white">
      <img src={a.image_url || `/trophies-badges/default.png`} className="w-16 h-16 mb-2 mx-auto" />
      <h3 className="font-bold text-center">{a.award_name}</h3>
      <p className="text-xs text-center text-gray-500">{a.award_class}</p>
    </div>
  ))}
</div>
```

---

## üéÆ 7Ô∏è‚É£ PLAYER DASHBOARD / CARD

* Fetch `/api/users/:id/awards`
* Display badges by tier color and show corresponding image
  (`<img src={award.image_url}>`)
* Include RSVP streak and next badge progress bar.

---

## üß† 8Ô∏è‚É£ FINAL INSTRUCTION TO REPLIT

> **Implement in BoxStat:**
>
> 1. Extend `users`, `awards`, `checkins`, `coach_feedback`, and `rsvps` tables as defined.
> 2. Add `/config/awards.config.json` and `/server/db/triggers.sql`.
> 3. Implement `awardEngine.ts` and connect triggers to all milestone events.
> 4. Fix RSVP submission logic to store correctly, track streaks, and trigger badge progression.
> 5. Update Admin ‚ÄúAwards & Badges‚Äù tab to include award images (from `/trophies-badges`).
> 6. Update Player Dashboard + Card to display live badges and trophies.
> 7. Confirm all triggers (check-in, RSVP, MVP, etc.) automatically award badges and update both dashboards in real time.

---

Would you like me to generate the **`awards.config.json` file contents** (all tiers and triggers, fully formatted for direct Replit import)?
That file alone defines every award condition and will make your award engine data-driven.
