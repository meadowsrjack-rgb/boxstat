To easily switch between sandbox and production modes for testing locally and in TestFlight, the most reliable method is to **tag each device token with its environment** when it registers with your backend.

Apple strictly separates these environments: a device token generated by an app installed via Xcode (development) only works with the **Sandbox gateway**, while a token from TestFlight (production) only works with the **Production gateway**.

### 1. Update the Frontend Registration

When your app registers for push notifications, detect the environment and send that information to your backend. In Capacitor, this can be done by checking if the app is in a "development" state.

```typescript
// On your iPhone app (e.g., in your Push Registration logic)
import { PushNotifications } from '@capacitor/push-notifications';

PushNotifications.addListener('registration', async (token) => {
  // Simple check: Xcode builds often have different URLs or flags
  const isSandbox = window.location.hostname === 'localhost'; 

  await fetch('https://boxstat.app/api/push/register', {
    method: 'POST',
    body: JSON.stringify({
      token: token.value,
      environment: isSandbox ? 'sandbox' : 'production' // Tag the token
    }),
    headers: { 'Content-Type': 'application/json' }
  });
});

```

---

### 2. Configure Environment-Aware Backend (Replit)

In your Replit backend, initialize **two separate providers**: one for Sandbox and one for Production. This allows your server to talk to both "rooms" simultaneously depending on which device it is targeting.

#### Update your `notificationService.ts`

```typescript
const apn = require('node-apn');

const commonConfig = {
  token: {
    key: "AuthKey_8F5HP72M74.p8",
    keyId: "8F5HP72M74",
    teamId: "YOUR_TEAM_ID"
  }
};

// SANDBOX PROVIDER (For Xcode/Local testing)
const sandboxProvider = new apn.Provider({
  ...commonConfig,
  production: false // Hits api.sandbox.push.apple.com
});

// PRODUCTION PROVIDER (For TestFlight/App Store)
const productionProvider = new apn.Provider({
  ...commonConfig,
  production: true // Hits api.push.apple.com
});

export async function sendPush(deviceToken, payload, environment = 'production') {
  const notification = new apn.Notification();
  notification.topic = "boxstat.app"; // Your Bundle ID
  notification.alert = payload;

  // AUTO-ROUTE: Choose provider based on the token's saved environment
  const provider = environment === 'sandbox' ? sandboxProvider : productionProvider;
  
  return await provider.send(notification, deviceToken);
}

```

---

### 3. Workflow for Testing

| Testing Stage | Build Method | APNs Gateway Used | Expected Behavior |
| --- | --- | --- | --- |
| **Local Testing** | Run from Xcode | `api.sandbox.push.apple.com` | Notification appears on your dev device. |
| **TestFlight** | Archive & Upload | `api.push.apple.com` | Notification appears on TestFlight devices. |

### Why this is better than "Feature Flags"

Using a single "Global Production Mode" Secret in Replit would force you to manually toggle the setting every time you want to test on your own phone vs. TestFlight. By saving the `environment` flag **per device token** in your database, your server automatically routes the notification to the correct Apple gateway without you needing to change a single line of code.

**Would you like me to help you write the SQL command to add an `environment` column to your existing `device_tokens` table?**